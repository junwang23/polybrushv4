!function(n){n.polybrush=function(){var t=n.dispatch("start","brush","end"),e=null,r=null,u=null,l=[],o=!0,s=!0,i=!1,c=null,h=n.line().x(function(n){return n[0]}).y(function(n){return n[1]}),a=function(t){e=t,t.each(function(){var e,o;e=(t=n.select(this).style("pointer-events","all").on("click.brush",b)).selectAll(".background").data([0]).enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair"),t.selectAll(".extent").data([l]).enter().append("path").attr("class","extent").style("cursor","move"),r&&(o=m(r.range()),e.attr("x",o[0]).attr("width",o[1]-o[0])),u&&(o=m(u.range()),e.attr("y",o[0]).attr("height",o[1]-o[0]))})},f=function(){return e.each(function(){n.select(this).selectAll("g path").attr("d",function(n){return h(n)+"Z"})})},m=function(n){var t,e;return t=n[0],e=n[n.length-1],t<e?[t,e]:[e,t]},d=function(n){var t,e,l,o;return t=m(r.range()),e=m(u.range()),l=Math.max(t[0],Math.min(t[1],n[0])),o=Math.max(e[0],Math.min(e[1],n[1])),n[0]===l&&n[1]===o},g=function(e){var r;r=n.mouse(e),s?(l.push(r),s=!1):(d(r)&&l.splice(l.length-1,1,r),f(),t.call("brush",this))},p=function(){return n.select(window).on("dblclick.brush",null).on("mousemove.brush",null),o=!0,2===l.length&&l[0][0]===l[1][0]&&l[0][1]===l[1][1]&&l.splice(0,l.length),n.select(".extent").on("mousedown.brush",x),t.call("end",this)},b=function(){var e,r=this;if(n.select(this),e=n.select(window),s=!0,!i)return o&&(l.splice(0,l.length),o=!1,n.select(".extent").on("mousedown.brush",null),e.on("mousemove.brush",function(){return g(r)}).on("dblclick.brush",p),t.call("start",this)),l.length>1&&l.pop(),l.push(n.mouse(this)),f();i=!1},v=function(e){var r,u,o,s,i,h,a,m,g,p;for(o=n.mouse(e),s=o[0]-c[0],i=o[1]-c[1],u=!1,c=o,h=function(n){n[0]+=s,n[1]+=i},a=0,g=l.length;a<g;a++)h(l[a]);for(r=function(n){return d(n)||(u=!0),u},m=0,p=l.length;m<p;m++)r(l[m]);if(!u)return f(),t.call("brush",this,{mode:"move"})},w=function(){return n.select(window).on("mousemove.brush",null).on("mouseup.brush",null),i=!0,t.call("end",this)},x=function(){var t=this;n.event.stopPropagation(),n.event.preventDefault(),o&&!a.empty()&&(n.select(window).on("mousemove.brush",function(){return v(t)}).on("mouseup.brush",w),c=n.mouse(this))};return a.isWithinExtent=function(n,t){var e,r,u,o,s,i,c;for(r=l.length-1,s=!1,e=i=0,c=l.length;i<c;e=++i)u=l[e],o=l[r],u[1]>t!=o[1]>t&&n<(o[0]-u[0])*(t-u[1])/(o[1]-u[1])+u[0]&&(s=!s),r=e;return s},a.x=function(n){return arguments.length?(r=n,a):r},a.y=function(n){return arguments.length?(u=n,a):u},a.extent=function(n){return arguments.length?(l=n,a):l},a.clear=function(){return l.splice(0,l.length),a},a.empty=function(){return 0===l.length},a.on=function(n,e){return t.on(n,e),a},a}}(d3);